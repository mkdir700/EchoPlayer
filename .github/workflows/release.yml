name: Release

run-name: ğŸš€ Release ${{ github.ref_name }}

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - alpha
      - beta

permissions:
  contents: write
  pull-requests: read

jobs:
  version-analysis:
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.semantic.outputs.next_version }}
      version_type: ${{ steps.branch.outputs.version_type }}
      is_prerelease: ${{ steps.branch.outputs.is_prerelease }}
      channel: ${{ steps.branch.outputs.channel }}
      should_release: ${{ steps.semantic.outputs.should_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Detect branch type and channel
        id: branch
        shell: bash
        run: |
          # æ ¹æ®åˆ†æ”¯åç¡®å®šç‰ˆæœ¬ç±»å‹å’Œæ›´æ–°æ¸ é“
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            VERSION_TYPE="stable"
            IS_PRERELEASE="false"
            CHANNEL="latest"
          elif [[ "${{ github.ref_name }}" == "beta" ]]; then
            VERSION_TYPE="beta"
            IS_PRERELEASE="true"
            CHANNEL="beta"
          elif [[ "${{ github.ref_name }}" == "alpha" ]]; then
            VERSION_TYPE="alpha"
            IS_PRERELEASE="true"
            CHANNEL="alpha"
          else
            echo "âŒ Unsupported branch: ${{ github.ref_name }}"
            exit 1
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Version Type: $VERSION_TYPE"
          echo "ğŸš€ Is Prerelease: $IS_PRERELEASE"
          echo "ğŸ“º Channel: $CHANNEL"

      - name: Run semantic-release for version analysis
        id: semantic
        shell: bash
        run: |
          echo "ğŸ” Analyzing commits to determine next version..."

          # åˆ›å»ºä¸´æ—¶çš„åˆ†æé…ç½®æ–‡ä»¶
          cat > .releaserc.temp.js << 'EOF'
          module.exports = {
            branches: [
              'main',
              { name: 'beta', prerelease: true },
              { name: 'alpha', prerelease: true }
            ],
            plugins: [
              '@semantic-release/commit-analyzer',
              '@semantic-release/release-notes-generator'
            ]
          }
          EOF

          # ä½¿ç”¨ä¸´æ—¶é…ç½®è¿›è¡Œç‰ˆæœ¬åˆ†æï¼Œè¾“å‡ºåˆ°ä¸´æ—¶æ–‡ä»¶
          pnpm semantic-release --dry-run -c .releaserc.temp.js > semantic_output.txt 2>&1

          # æ˜¾ç¤ºè¾“å‡ºå†…å®¹ä»¥ä¾¿è°ƒè¯•
          echo "=== Semantic Release Output ==="
          cat semantic_output.txt
          echo "=== End of Output ==="

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f .releaserc.temp.js

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬éœ€è¦å‘å¸ƒï¼ˆä»æ–‡ä»¶ä¸­æœç´¢ï¼Œé¿å…å˜é‡é•¿åº¦é™åˆ¶ï¼‰
          if grep -q "next release version is" semantic_output.txt; then
            NEXT_VERSION=$(grep "next release version is" semantic_output.txt | sed 's/.*next release version is \([0-9.a-z-]*\).*/\1/' | head -1)
            echo "âœ… Next version: $NEXT_VERSION"
            echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No new version to release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

          # æ¸…ç†ä¸´æ—¶è¾“å‡ºæ–‡ä»¶
          rm -f semantic_output.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: version-analysis
    runs-on: ${{ matrix.os }}
    if: needs.version-analysis.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows builds - æ”¯æŒ x64 å’Œ ARM64 æ¶æ„
          - os: windows-latest
            platform: win
            target: --win
          # macOS builds - æ”¯æŒ Intel å’Œ Apple Silicon æ¶æ„
          - os: macos-latest
            platform: mac
            target: --mac
          # Linux builds - æ”¯æŒ x64 å’Œ ARM64 æ¶æ„
          - os: ubuntu-latest
            platform: linux
            target: --linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Rebuild native modules (macOS)
        if: matrix.platform == 'mac'
        shell: bash
        run: |
          echo "ğŸ”§ Rebuilding native modules for macOS"
          pnpm rebuild @swc/core

      - name: Update package.json version
        shell: bash
        run: |
          echo "ğŸ“‹ Current package.json version: $(node -p "require('./package.json').version")"
          echo "ğŸ”„ Target version: ${{ needs.version-analysis.outputs.next_version }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Version type: ${{ needs.version-analysis.outputs.version_type }}"
          echo "ğŸš€ Is prerelease: ${{ needs.version-analysis.outputs.is_prerelease }}"
          echo "ğŸ“º Channel: ${{ needs.version-analysis.outputs.channel }}"

          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬å·
          node -e "
            const fs = require('fs');
            const package = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            package.version = '${{ needs.version-analysis.outputs.next_version }}';
            fs.writeFileSync('package.json', JSON.stringify(package, null, 2) + '\n');
            console.log('âœ… Updated package.json version to:', package.version);
          "

          echo "ğŸ“‹ Updated package.json version: $(node -p "require('./package.json').version")"

      - name: Build for ${{ matrix.platform }}
        shell: bash
        run: |
          echo "ğŸ—ï¸ Building for ${{ matrix.platform }}"
          echo "ğŸ“¦ ç‰ˆæœ¬å·: ${{ needs.version-analysis.outputs.next_version }}"
          echo "ğŸ“¦ ç‰ˆæœ¬ç±»å‹: ${{ needs.version-analysis.outputs.version_type }}"
          echo "ğŸ”„ æ›´æ–°æ¸ é“: ${{ needs.version-analysis.outputs.channel }}"
          pnpm build

          # æ„å»ºäº§ç‰©ä½†ä¸å‘å¸ƒï¼Œç‰ˆæœ¬å·å·²ç»æ­£ç¡®
          echo "ğŸ—ï¸ Building artifacts with correct version number"
          echo "ğŸ“¦ Artifacts will be uploaded by final release job"
          pnpm exec electron-builder ${{ matrix.target }} --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # æ ¹æ®åˆ†æ”¯è®¾ç½®æ›´æ–°æ¸ é“
          ELECTRON_BUILDER_CHANNEL: ${{ needs.version-analysis.outputs.channel }}

      - name: List build artifacts
        shell: bash
        run: |
          echo "ğŸ“¦ Build artifacts in dist directory:"
          if [ -d "dist" ]; then
            if command -v ls >/dev/null 2>&1; then
              ls -la dist/
            else
              # Windows fallback
              dir dist /a
            fi
          else
            echo "No dist directory found"
          fi
          echo "ğŸ“ Current directory contents:"
          if command -v ls >/dev/null 2>&1; then
            ls -la
          else
            # Windows fallback
            dir /a
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.zip
            dist/*.AppImage
            dist/*.deb
            dist/*.yml
            dist/*.yaml
            dist/*.blockmap
          retention-days: 30
          if-no-files-found: warn

  semantic-release:
    needs: [version-analysis, release]
    runs-on: ubuntu-latest
    if: needs.version-analysis.outputs.should_release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # semantic-release éœ€è¦å®Œæ•´çš„ git å†å²

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update package.json version for release
        shell: bash
        run: |
          echo "ğŸ”„ Updating package.json version for semantic-release"
          echo "Target version: ${{ needs.version-analysis.outputs.next_version }}"

          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬å·ï¼Œç¡®ä¿ä¸åˆ†æé˜¶æ®µä¸€è‡´
          node -e "
            const fs = require('fs');
            const package = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            package.version = '${{ needs.version-analysis.outputs.next_version }}';
            fs.writeFileSync('package.json', JSON.stringify(package, null, 2) + '\n');
            console.log('âœ… Updated package.json version to:', package.version);
          "

      - name: Prepare artifacts for release
        run: |
          echo "ğŸ“¦ Preparing artifacts for GitHub Release"
          mkdir -p dist
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ° dist ç›®å½•
          find artifacts -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.yml" -o -name "*.yaml" -o -name "*.blockmap" | while read file; do
            cp "$file" dist/
            echo "ğŸ“ Copied: $(basename "$file")"
          done
          ls -la dist/

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Creating GitHub Release with semantic-release"
          echo "ğŸ“¦ Version: ${{ needs.version-analysis.outputs.next_version }}"
          pnpm semantic-release

  upload-to-cos:
    needs: [version-analysis, release, semantic-release]
    runs-on: ubuntu-latest
    if: needs.version-analysis.outputs.should_release == 'true' && needs.semantic-release.result == 'success'
    strategy:
      matrix:
        retry: [1, 2, 3]
      max-parallel: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare artifacts for COS upload
        run: |
          echo "ğŸ“¦ Preparing artifacts for COS upload"
          mkdir -p dist
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ° dist ç›®å½•
          find artifacts -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.yml" -o -name "*.yaml" -o -name "*.blockmap" | while read file; do
            cp "$file" dist/
            echo "ğŸ“ Copied: $(basename "$file")"
          done
          ls -la dist/

      - name: Install coscmd for Tencent Cloud COS
        run: |
          echo "ğŸ“¦ Installing coscmd for Tencent Cloud COS upload (Attempt ${{ matrix.retry }})"
          pip install coscmd

      - name: Configure coscmd
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          echo "ğŸ”§ Configuring coscmd (Attempt ${{ matrix.retry }})"
          coscmd config -a $COS_SECRET_ID -s $COS_SECRET_KEY -b $COS_BUCKET -r $COS_REGION

      - name: Upload artifacts to Tencent Cloud COS
        env:
          VERSION: ${{ needs.version-analysis.outputs.next_version }}
          CHANNEL: ${{ needs.version-analysis.outputs.channel }}
        run: |
          echo "â˜ï¸ Uploading artifacts to Tencent Cloud COS (Attempt ${{ matrix.retry }})"
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“º Channel: $CHANNEL"

          # åˆ›å»ºç‰ˆæœ¬ç›®å½•è·¯å¾„
          COS_PATH="releases/$CHANNEL/$VERSION"
          echo "ğŸ“ COS path: $COS_PATH"

          # ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
          echo "ğŸ“¤ Uploading build artifacts..."
          for file in dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "  ğŸ“„ Uploading: $filename"
              coscmd upload "$file" "$COS_PATH/$filename"
            fi
          done

          echo "âœ… All artifacts uploaded successfully"
          echo "ğŸ”— Artifacts are available at: $COS_PATH"

  notify:
    needs: [version-analysis, release, semantic-release, upload-to-cos]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Status Summary
        run: |
          echo "ğŸ—ï¸ Build Summary"
          echo "==============="
          echo "Branch: ${{ github.ref_name }}"
          echo "Next Version: ${{ needs.version-analysis.outputs.next_version }}"
          echo "Type: ${{ needs.version-analysis.outputs.version_type }}"
          echo "Channel: ${{ needs.version-analysis.outputs.channel }}"
          echo "Prerelease: ${{ needs.version-analysis.outputs.is_prerelease }}"
          echo "Should Release: ${{ needs.version-analysis.outputs.should_release }}"
          echo "Build Status: ${{ needs.release.result }}"
          echo "Release Status: ${{ needs.semantic-release.result }}"
          echo "COS Upload Status: ${{ needs.upload-to-cos.result }}"
          echo "Trigger: ${{ github.event_name }}"
          echo ""

          if [ "${{ needs.version-analysis.outputs.should_release }}" == "false" ]; then
            echo "â„¹ï¸ No new version to release - no commits since last release"
          elif [ "${{ needs.release.result }}" == "success" ]; then
            if [ "${{ needs.semantic-release.result }}" == "success" ]; then
              echo "ğŸ‰ Release ${{ needs.version-analysis.outputs.next_version }} created successfully!"
              echo "ğŸ“ Check: https://github.com/${{ github.repository }}/releases"
              echo "ğŸ”„ Version was automatically determined based on commit messages"
              echo "ğŸ“¦ Artifacts have correct version numbers in filenames"

              if [ "${{ needs.upload-to-cos.result }}" == "success" ]; then
                echo "â˜ï¸ Artifacts uploaded to Tencent Cloud COS successfully"
              elif [ "${{ needs.upload-to-cos.result }}" == "failure" ]; then
                echo "âŒ COS upload failed - artifacts may not be available for auto-update"
                echo "ğŸ’¡ Check upload-to-cos job logs for details"
              else
                echo "â³ COS upload status: ${{ needs.upload-to-cos.result }}"
              fi

              echo ""
              if [ "${{ needs.version-analysis.outputs.is_prerelease }}" == "true" ]; then
                echo "ğŸ§ª This is a prerelease version:"
                echo "- Alpha/Beta versions are marked as prerelease"
                echo "- Auto-update is enabled for prerelease users"
              else
                echo "ğŸš€ This is a stable release"
              fi
            else
              echo "ğŸ“¦ Build completed but semantic-release failed"
              echo "ğŸ’¡ Check semantic-release logs for details"
            fi
          else
            echo "âŒ Build failed - check logs for details"
          fi
